<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Card | The Lalit Imperial</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="init.js"></script>
    <style>
        /* Report Card Design */
        .report-card-container {
            width: 210mm; min-height: 297mm; padding: 15mm;
            margin: auto; background: white; border: 15px double var(--primary);
            position: relative; box-sizing: border-box;
        }
        .report-card-container::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('logo.png') no-repeat center; background-size: 450px;
            opacity: 0.04; z-index: 0;
        }
        .header-table, .info-table, .marks-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; position: relative; z-index: 1; }
        .marks-table th, .marks-table td { border: 1px solid #000; padding: 10px; text-align: center; font-size: 13px; }
        .marks-table th { background: #f2f2f2; font-family: 'Cinzel', serif; }
        
        .result-banner { 
            background: var(--primary); color: var(--accent); 
            padding: 12px; text-align: center; font-family: 'Cinzel', serif; font-size: 1.3rem;
            margin-bottom: 20px; border-radius: 5px;
        }
        .grade-txt { font-weight: bold; color: var(--primary); }
        
        @media print {
            body { background: none; padding: 0; }
            .no-print, .sidebar { display: none !important; }
            .main-content { padding: 0; margin: 0; }
            .report-card-container { border: 12px double var(--primary); margin: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="wrapper">
    <script src="menu.js"></script>

    <div class="main-content">
        <div class="royal-card no-print">
            <h2 class="card-title"><i class="fas fa-file-contract"></i> Generate Progress Report</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Student Admission ID</label>
                    <input type="number" id="rptID" placeholder="Enter ID (e.g. 20260001)">
                </div>
                <div class="form-group">
                    <label>Select Examination</label>
                    <select id="rptExam">
                        <option value="">-- Choose Exam --</option>
                    </select>
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                    <button class="btn-royal" onclick="generateImperialReport()"><i class="fas fa-magic"></i> Create Report Card</button>
                </div>
            </div>
        </div>

        <div id="printArea" style="display: none;">
            <div class="report-card-container">
                <table class="header-table">
                    <tr>
                        <td width="110"><img src="logo.png" width="100"></td>
                        <td align="center">
                            <h1 style="font-family:'Cinzel'; color:var(--primary); margin:0; font-size:2.2rem;">THE LALIT INTERNATIONAL SCHOOL</h1>
                            <p style="margin:5px 0; font-weight:bold; letter-spacing:1px;">Affiliated to CBSE | Session 2025-26</p>
                            <p style="font-size:0.8rem; text-transform:uppercase;">Official Performance Record & Progress Archive</p>
                        </td>
                    </tr>
                </table>

                <div class="result-banner" id="rptExamTitle">---</div>

                <table class="info-table" style="border: 1px solid #000; padding: 10px; background: rgba(0,0,0,0.01);">
                    <tr>
                        <td width="75%" style="padding: 15px; line-height: 1.8;">
                            Student Name: <b id="rptName" style="color:var(--primary); font-size:1.1rem;">---</b><br>
                            Father's Name: <b id="rptFather">---</b><br>
                            Mother's Name: <b id="rptMother">---</b><br>
                            Admission ID: <b id="rptUID">---</b> | Class & Sec: <b id="rptClass">---</b>
                        </td>
                        <td align="right" style="padding: 10px;">
                            <img id="rptPhoto" src="" style="width:110px; height:130px; border:3px solid var(--accent); object-fit:cover;">
                        </td>
                    </tr>
                </table>

                <table class="marks-table">
                    <thead>
                        <tr>
                            <th>SUBJECTS</th>
                            <th>MAX MARKS</th>
                            <th>THEORY</th>
                            <th>PRACTICAL</th>
                            <th>TOTAL</th>
                            <th>GRADE</th>
                        </tr>
                    </thead>
                    <tbody id="rptBody"></tbody>
                    <tfoot>
                        <tr style="background:#f2f2f2; font-weight:bold; font-size:1.1rem;">
                            <td colspan="4" align="right">GRAND TOTAL & PERCENTAGE:</td>
                            <td id="rptGrandTotal">---</td>
                            <td id="rptGrandPerc">---</td>
                        </tr>
                    </tfoot>
                </table>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div style="border:1px solid #000; padding:15px; background:#fcfcfc;">
                        <p><b>Attendance Record:</b> <span id="rptAttendance">0/0 Days</span></p>
                        <p><b>Overall Result:</b> <b id="rptStatus" style="color:var(--success)">PASSED</b></p>
                    </div>
                    <div style="border:1px solid #000; padding:15px; background:#fcfcfc;">
                        <p><b>Teacher's Remarks:</b></p>
                        <p id="rptRemarks" style="font-style:italic; font-size:0.85rem;">"Shows great potential. Consistent effort will lead to academic excellence."</p>
                    </div>
                </div>

                <div style="font-size: 0.65rem; margin-top: 20px; border: 1px dashed #999; padding: 5px; color: #555;">
                    <b>GRADING SCALE:</b> A1 (91-100), A2 (81-90), B1 (71-80), B2 (61-70), C1 (51-60), C2 (41-50), D (33-40), E (Failed)
                </div>

                <div style="display:flex; justify-content:space-between; margin-top:80px; text-align:center;">
                    <div style="border-top:1px solid #000; width:160px; padding-top:5px;">Class Teacher</div>
                    <div style="border-top:1px solid #000; width:160px; padding-top:5px;">Principal</div>
                    <div style="border-top:1px solid #000; width:160px; padding-top:5px;">Parent's Signature</div>
                </div>
            </div>
            
            <div class="no-print text-center mt-4">
                <button class="btn-royal" onclick="window.print()" style="padding:15px 60px;"><i class="fas fa-print"></i> Print Official Progress Report</button>
            </div>
        </div>
    </div>
</div>

<script>
// Load Exam List
async function initRpt() {
    const snap = await db.collection('exam_settings').get();
    const sel = document.getElementById('rptExam');
    snap.forEach(doc => {
        sel.innerHTML += `<option value="${doc.id}">${doc.data().examName} (Class ${doc.data().targetClass})</option>`;
    });
}

async function generateImperialReport() {
    const sid = document.getElementById('rptID').value;
    const exID = document.getElementById('rptExam').value;
    if(!sid || !exID) return alert("Select Student ID and Exam!");

    // 1. Fetch Student Details
    const sDoc = await db.collection('students').doc(sid).get();
    if(!sDoc.exists) return alert("Student not found in Registry!");
    const s = sDoc.data();

    // 2. Fetch Exam Settings
    const exDoc = await db.collection('exam_settings').doc(exID).get();
    const exData = exDoc.data();

    // 3. Fetch Marks
    const mSnap = await db.collection('marks_entry').where("studentID", "==", Number(sid)).where("examID", "==", exID).get();
    const marksMap = {};
    mSnap.forEach(doc => { marksMap[doc.data().subject] = doc.data(); });

    // 4. Fetch Attendance
    const attSnap = await db.collection('attendance').where("studentID", "==", Number(sid)).get();
    let present = 0;
    attSnap.forEach(doc => { if(doc.data().status === "Present") present++; });

    // Populate UI
    document.getElementById('rptName').innerText = s.name.toUpperCase();
    document.getElementById('rptFather').innerText = s.father.toUpperCase();
    document.getElementById('rptMother').innerText = s.mother ? s.mother.toUpperCase() : "---";
    document.getElementById('rptUID').innerText = s.uniqueID;
    document.getElementById('rptClass').innerText = `${s.class}-${s.section || 'A'}`;
    document.getElementById('rptPhoto').src = s.photo || 'https://via.placeholder.com/100';
    document.getElementById('rptExamTitle').innerText = exData.examName.toUpperCase();
    document.getElementById('rptAttendance').innerText = `${present} Days`;

    // Process Table
    let tableHTML = "";
    let grandTotal = 0;
    let maxGrand = 0;

    exData.subjects.forEach(sub => {
        const m = marksMap[sub.name] || { theory: 0, practical: 0 };
        const totalSub = (m.theory || 0) + (m.practical || 0);
        const maxSub = sub.maxTheory + sub.maxPrac;
        grandTotal += totalSub;
        maxGrand += maxSub;

        tableHTML += `
            <tr>
                <td align="left"><b>${sub.name.toUpperCase()}</b></td>
                <td>${maxSub}</td>
                <td>${m.theory || 0}</td>
                <td>${m.practical || 0}</td>
                <td><b>${totalSub}</b></td>
                <td class="grade-txt">${calculateImperialGrade(totalSub, maxSub)}</td>
            </tr>`;
    });

    document.getElementById('rptBody').innerHTML = tableHTML;
    document.getElementById('rptGrandTotal').innerText = `${grandTotal} / ${maxGrand}`;
    const perc = ((grandTotal / maxGrand) * 100).toFixed(1);
    document.getElementById('rptGrandPerc').innerText = perc + "%";
    document.getElementById('rptStatus').innerText = perc >= 33 ? "PASSED" : "NEEDS IMPROVEMENT";
    document.getElementById('rptStatus').style.color = perc >= 33 ? "var(--success)" : "var(--danger)";

    document.getElementById('printArea').style.display = "block";
}

function calculateImperialGrade(m, max) {
    const p = (m / max) * 100;
    if(p >= 91) return "A1";
    if(p >= 81) return "A2";
    if(p >= 71) return "B1";
    if(p >= 61) return "B2";
    if(p >= 51) return "C1";
    if(p >= 41) return "C2";
    if(p >= 33) return "D";
    return "E";
}

window.onload = initRpt;
</script>
</body>
</html>
