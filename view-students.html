<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registry | The Lalit</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        .filter-row {
            display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;
            background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ddd;
        }
        .status-badge {
            padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold;
        }
        .bg-hostel { background: #e1f5fe; color: #0288d1; }
        .bg-bus { background: #fff3e0; color: #ef6c00; }
        .std-photo-thumb {
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-color);
        }
    </style>
</head>
<body>

<div class="main-content">
    <div class="royal-card">
        <h2 class="card-title"><i class="fas fa-address-book"></i> Student Registry Log</h2>
        
        <div class="filter-row">
            <div style="flex: 2; min-width: 250px;">
                <label>Search Name/ID</label>
                <input type="text" id="searchInput" placeholder="Type to search..." oninput="filterData()">
            </div>
            <div style="flex: 1;">
                <label>Class</label>
                <select id="filterClass" onchange="filterData()">
                    <option value="">All Classes</option>
                    <option value="Nursery">Nursery</option>
                    <option value="LKG">LKG</option><option value="UKG">UKG</option>
                    <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
                </select>
            </div>
            <div style="flex: 0.5; display: flex; align-items: flex-end;">
                <button class="btn-royal" onclick="window.print()"><i class="fas fa-print"></i> Print</button>
            </div>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Photo</th>
                        <th>Student Name</th>
                        <th>ID & Class</th>
                        <th>Guardian</th>
                        <th>Facilities</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="registryBody">
                    <tr><td colspan="7" style="text-align:center;">Fetching Records from Registry...</td></tr>
                </tbody>
            </table>
        </div>
        <div id="stats" style="margin-top: 15px; font-weight: bold; color: var(--primary-color);"></div>
    </div>
</div>

<script src="menu.js"></script>
<script>
// --- Firebase Setup ---
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let allStudents = [];

// Load Data from Firestore
async function loadRegistry() {
    try {
        const snap = await db.collection('students').orderBy('uniqueID', 'asc').get();
        allStudents = [];
        snap.forEach(doc => allStudents.push(doc.data()));
        renderTable(allStudents);
    } catch (err) {
        console.error(err);
        document.getElementById('registryBody').innerHTML = `<tr><td colspan="7" style="color:red;">Error loading records.</td></tr>`;
    }
}

function renderTable(data) {
    const tbody = document.getElementById('registryBody');
    tbody.innerHTML = "";
    
    data.forEach((s, index) => {
        tbody.innerHTML += `
            <tr>
                <td>${index + 1}</td>
                <td><img src="${s.photo || 'https://via.placeholder.com/50'}" class="std-photo-thumb"></td>
                <td>
                    <b style="color:var(--primary-color); cursor:pointer;" onclick="viewProfile(${s.uniqueID})">${s.name}</b><br>
                    <small style="color:#666;"><i class="fas fa-phone"></i> ${s.mobile}</small>
                </td>
                <td>
                    <span class="badge" style="background:var(--primary-color); color:var(--accent-color); padding:2px 5px; border-radius:4px;">ID: ${s.uniqueID}</span><br>
                    Class: ${s.class} (${s.section})
                </td>
                <td>${s.father}</td>
                <td>
                    ${s.hostel === 'Yes' ? '<span class="status-badge bg-hostel">Hostel</span>' : ''}
                    ${s.transport === 'Yes' ? '<span class="status-badge bg-bus">Bus</span>' : ''}
                    ${s.hostel === 'No' && s.transport === 'No' ? '<small>-</small>' : ''}
                </td>
                <td>
                    <button class="btn-royal" style="padding:5px 10px; font-size:0.7rem;" onclick="viewProfile(${s.uniqueID})"><i class="fas fa-eye"></i> View</button>
                </td>
            </tr>`;
    });
    document.getElementById('stats').innerText = "Total Students in View: " + data.length;
}

// Client-side Filtering
function filterData() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const cls = document.getElementById('filterClass').value;

    const filtered = allStudents.filter(s => {
        const matchesSearch = s.name.toLowerCase().includes(term) || s.uniqueID.toString().includes(term);
        const matchesClass = cls === "" || s.class === cls;
        return matchesSearch && matchesClass;
    });

    renderTable(filtered);
}

function viewProfile(id) {
    // Redirect to profile page with ID
    window.location.href = `profile.html?id=${id}`;
}

window.onload = loadRegistry;
</script>
</body>
</html>
