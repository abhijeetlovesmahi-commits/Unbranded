<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Admission | The Lalit</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="main-content">
    <div class="royal-card">
        <h2 class="card-title"><i class="fas fa-user-plus"></i> Student Admission Registry</h2>
        
        <form id="admissionForm">
            <div class="form-section mb-4" style="text-align:center;">
                <label>Student Official Photo</label><br>
                <input type="file" id="stPhoto" accept="image/*" onchange="previewImg(this)" style="display:none;">
                <div onclick="document.getElementById('stPhoto').click()" style="cursor:pointer;">
                    <img id="imgPreview" src="https://via.placeholder.com/150x180?text=Upload+Photo" 
                         style="width:130px; height:160px; border:2px solid var(--accent-color); object-fit:cover;">
                </div>
            </div>

            <h5 class="section-subtitle">I. Personal Details</h5>
            <div class="form-grid mb-4">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="sName" placeholder="As per Aadhar" required>
                </div>
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" id="sDob" required>
                </div>
                <div class="form-group">
                    <label>Gender</label>
                    <select id="sGender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Aadhar Number</label>
                    <input type="number" id="sAadhar" placeholder="12 Digit No." oninput="this.value=this.value.slice(0,12)">
                </div>
            </div>

            <h5 class="section-subtitle">II. Academic & Facilities</h5>
            <div class="form-grid mb-4">
                <div class="form-group">
                    <label>Admission Class</label>
                    <select id="sClass" required>
                        <option value="">Select Class</option>
                        <option value="Nursery">Nursery</option>
                        <option value="LKG">LKG</option>
                        <option value="UKG">UKG</option>
                        <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">Class ${i}</option>`);</script>
                    </select>
                </div>
                <div class="form-group">
                    <label>Section</label>
                    <select id="sSection"><option value="A">A</option><option value="B">B</option></select>
                </div>
                <div class="form-group">
                    <label>Hostel Facility</label>
                    <select id="sHostel">
                        <option value="No">No</option>
                        <option value="Yes">Yes (Apply Hostel Charges)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Transport Service</label>
                    <select id="sTransport" onchange="toggleTransport()">
                        <option value="No">No</option>
                        <option value="Yes">Yes (Apply Slab Rates)</option>
                    </select>
                </div>
                <div class="form-group" id="slabDiv" style="display:none;">
                    <label>Distance Slab</label>
                    <select id="sSlab">
                        <option value="">Select Slab</option>
                        <option value="0-3km">0 - 3 km</option>
                        <option value="3-6km">3 - 6 km</option>
                        <option value="6-9km">6 - 9 km</option>
                        <option value="9km+">Above 9 km</option>
                    </select>
                </div>
            </div>

            <h5 class="section-subtitle">III. Guardian Details</h5>
            <div class="form-grid mb-4">
                <div class="form-group"><label>Father's Name</label><input type="text" id="sFather" required></div>
                <div class="form-group"><label>Mother's Name</label><input type="text" id="sMother"></div>
                <div class="form-group"><label>Primary Contact</label><input type="tel" id="sPhone" required></div>
            </div>

            <div class="form-group mb-4">
                <label>Residential Address</label>
                <textarea id="sAddress" rows="2" placeholder="Full Address..."></textarea>
            </div>

            <button type="submit" class="btn-royal w-100">Confirm & Register Student</button>
        </form>
    </div>
</div>

<script src="menu.js"></script>
<script>
// --- Firebase Config & Logic ---
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let compressedPhoto = "";

function previewImg(input) {
    if (input.files && input.files[0]) {
        let reader = new FileReader();
        reader.onload = function(e) {
            let img = new Image();
            img.src = e.target.result;
            img.onload = function() {
                let canvas = document.createElement('canvas');
                canvas.width = 150; canvas.height = 180;
                canvas.getContext('2d').drawImage(img, 0, 0, 150, 180);
                compressedPhoto = canvas.toDataURL('image/jpeg', 0.7);
                document.getElementById('imgPreview').src = compressedPhoto;
            }
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function toggleTransport() {
    document.getElementById('slabDiv').style.display = 
        document.getElementById('sTransport').value === 'Yes' ? 'block' : 'none';
}

document.getElementById('admissionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = e.target.querySelector('button');
    submitBtn.innerText = "Processing Treasury...";
    submitBtn.disabled = true;

    try {
        // Generate Unique ID (Custom Logic)
        const lastSnap = await db.collection('students').orderBy('uniqueID', 'desc').limit(1).get();
        const nextID = lastSnap.empty ? 2026001 : Number(lastSnap.docs[0].data().uniqueID) + 1;

        const studentData = {
            uniqueID: nextID,
            name: document.getElementById('sName').value,
            dob: document.getElementById('sDob').value,
            gender: document.getElementById('sGender').value,
            aadhar: document.getElementById('sAadhar').value,
            class: document.getElementById('sClass').value,
            section: document.getElementById('sSection').value,
            hostel: document.getElementById('sHostel').value,
            transport: document.getElementById('sTransport').value,
            slab: document.getElementById('sSlab').value,
            father: document.getElementById('sFather').value,
            mother: document.getElementById('sMother').value,
            mobile: document.getElementById('sPhone').value,
            address: document.getElementById('sAddress').value,
            photo: compressedPhoto,
            timestamp: Date.now()
        };

        await db.collection('students').doc(nextID.toString()).set(studentData);
        alert("Success! Admission Completed. ID: " + nextID);
        location.reload();
    } catch (err) {
        alert("Error: " + err.message);
        submitBtn.disabled = false;
    }
});
</script>
</body>
</html>
