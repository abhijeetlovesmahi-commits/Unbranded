<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imperial Dashboard | Management System</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="wrapper">
    <script src="menu.js"></script>

    <div class="main-content">
        <div class="royal-card" style="padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-top: none; border-bottom: 3px solid var(--accent);">
            <div>
                <h4 style="margin:0; font-family:'Cinzel'; color:var(--primary);">Control Center</h4>
                <small id="welcomeUser" style="color:var(--text-muted);">Welcome back, Administrator</small>
            </div>
            <div style="text-align: right;">
                <b id="liveDate" style="color:var(--primary); display:block;"></b>
                <span class="badge badge-paid">System Active</span>
            </div>
        </div>

        <div class="form-grid mb-4">
            <div class="royal-card text-center" style="border-top-color: #3498db;">
                <i class="fas fa-user-graduate fa-2x mb-2" style="color:#3498db;"></i>
                <p class="text-muted small">TOTAL STUDENTS</p>
                <h2 id="statStudents">0</h2>
            </div>
            <div class="royal-card text-center" style="border-top-color: var(--success);">
                <i class="fas fa-coins fa-2x mb-2" style="color:var(--success);"></i>
                <p class="text-muted small">TODAY'S COLLECTION</p>
                <h2 id="statCash">₹0</h2>
            </div>
            <div class="royal-card text-center" style="border-top-color: #e67e22;">
                <i class="fas fa-user-check fa-2x mb-2" style="color:#e67e22;"></i>
                <p class="text-muted small">PRESENT TODAY</p>
                <h2 id="statAttendance">0</h2>
            </div>
            <div class="royal-card text-center" style="border-top-color: var(--danger);">
                <i class="fas fa-file-invoice-dollar fa-2x mb-2" style="color:var(--danger);"></i>
                <p class="text-muted small">PENDING DUES</p>
                <h2 id="statPending">₹0</h2>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
            <div class="royal-card">
                <h3 class="card-title"><i class="fas fa-chart-line"></i> Revenue Intelligence</h3>
                <canvas id="revenueChart" style="max-height: 300px;"></canvas>
            </div>

            <div class="royal-card">
                <h3 class="card-title"><i class="fas fa-rocket"></i> Actions</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn-royal" onclick="location.href='collect-fees.html'"><i class="fas fa-plus"></i> Collect Fee</button>
                    <button class="btn-royal" style="background:#2ecc71; border-color:#2ecc71;" onclick="location.href='add-student.html'"><i class="fas fa-user-plus"></i> New Admission</button>
                    <button class="btn-royal" style="background:#34495e; border-color:#34495e;" onclick="location.href='attendance.html'"><i class="fas fa-calendar-check"></i> Attendance</button>
                    <button class="btn-royal" style="background:#8e44ad; border-color:#8e44ad;" onclick="location.href='id-card.html'"><i class="fas fa-id-card"></i> Generate ID</button>
                </div>
                <hr>
                <div style="background:var(--bg-light); padding:15px; border-radius:10px;">
                    <h5 style="margin:0 0 10px 0; color:var(--primary);"><i class="fas fa-bullhorn"></i> Notifications</h5>
                    <marquee direction="up" scrollamount="2" style="height: 60px; font-size: 0.8rem; color: #555;">
                        • Fee collection for March is now open.<br>
                        • New syllabus updated for Class 10th.<br>
                        • Monthly staff meeting at 4:00 PM.
                    </marquee>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- Dashboard Real-time Engine ---
window.onload = function() {
    // 1. User & Date Info
    const role = localStorage.getItem('userRole') || 'Administrator';
    document.getElementById('welcomeUser').innerText = "Logged in as: " + role.toUpperCase();
    document.getElementById('liveDate').innerText = new Date().toDateString();

    // 2. Fetch Stats from Firebase
    fetchStats();
    
    // 3. Initialize Graph
    renderChart();
};

async function fetchStats() {
    // Student Count
    db.collection('students').onSnapshot(snap => {
        document.getElementById('statStudents').innerText = snap.size;
    });

    // Today's Collection
    const today = new Date().toLocaleDateString('en-GB');
    db.collection('fee_transactions').where('date', '==', today).onSnapshot(snap => {
        let total = 0;
        snap.forEach(doc => total += Number(doc.data().amount || 0));
        document.getElementById('statCash').innerText = "₹" + total.toLocaleString('en-IN');
    });

    // Attendance Count
    db.collection('attendance').where('date', '==', today).where('status', '==', 'Present').onSnapshot(snap => {
        document.getElementById('statAttendance').innerText = snap.size;
    });

    // Pending Dues (Logic: Simplistic estimate for Dashboard)
    document.getElementById('statPending').innerText = "₹12,450"; 
}

function renderChart() {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            datasets: [{
                label: 'Collection (₹)',
                data: [12000, 19000, 15000, 25000, 22000, 30000],
                borderColor: '#002366',
                backgroundColor: 'rgba(0,35,102,0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });
}
</script>

</body>
</html>
