<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance | The Lalit</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        .attendance-card {
            display: flex; align-items: center; justify-content: space-between;
            background: #fff; padding: 12px 20px; border-radius: 8px;
            margin-bottom: 10px; border: 1px solid #ddd; transition: 0.3s;
        }
        .attendance-card:hover { border-color: var(--primary-color); }
        
        /* Custom Toggle Switch for Present/Absent */
        .switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--danger); transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(30px); }
        
        .status-label { font-weight: bold; font-size: 0.8rem; width: 60px; text-align: center; }
        .present-text { color: var(--success); }
        .absent-text { color: var(--danger); }
    </style>
</head>
<body>

<div class="main-content">
    <div class="royal-card">
        <h2 class="card-title"><i class="fas fa-calendar-check"></i> Daily Attendance Registry</h2>

        <div class="form-section no-print">
            <div class="form-grid">
                <div class="form-group">
                    <label>Attendance Date</label>
                    <input type="date" id="attDate">
                </div>
                <div class="form-group">
                    <label>Class</label>
                    <select id="attClass">
                        <option value="">Select Class</option>
                        <option value="Nursery">Nursery</option>
                        <option value="LKG">LKG</option><option value="UKG">UKG</option>
                        <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">${i}</option>`);</script>
                    </select>
                </div>
                <div class="form-group">
                    <label>Section</label>
                    <select id="attSection"><option value="A">A</option><option value="B">B</option></select>
                </div>
                <div class="form-group" style="justify-content: flex-end; display: flex;">
                    <button class="btn-royal" onclick="fetchStudentsForAttendance()"><i class="fas fa-users"></i> Load Students</button>
                </div>
            </div>
        </div>

        <div id="attendanceListArea" style="display:none; margin-top:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:var(--bg-light); padding:10px; border-radius:5px;">
                <span id="listInfo" style="font-weight:bold; color:var(--primary-color);"></span>
                <button class="btn-royal" onclick="markAllPresent()" style="background:#34495e; font-size:0.7rem;">Mark All Present</button>
            </div>
            
            <div id="studentContainer">
                </div>

            <button class="btn-royal w-100 mt-4" onclick="saveAttendance()"><i class="fas fa-cloud-upload-alt"></i> Save Attendance to Cloud</button>
        </div>
    </div>
</div>

<script src="menu.js"></script>
<script>
// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Default date to today
document.getElementById('attDate').valueAsDate = new Date();

let currentStudents = [];

async function fetchStudentsForAttendance() {
    const cls = document.getElementById('attClass').value;
    const sec = document.getElementById('attSection').value;
    const date = document.getElementById('attDate').value;

    if(!cls || !date) return alert("Please select Class and Date!");

    const container = document.getElementById('studentContainer');
    container.innerHTML = "<p style='text-align:center;'>Fetching Students...</p>";
    document.getElementById('attendanceListArea').style.display = "block";

    try {
        const snap = await db.collection('students')
            .where("class", "==", cls)
            .where("section", "==", sec)
            .get();

        if(snap.empty) {
            container.innerHTML = "<p style='text-align:center; color:red;'>No students found in this section.</p>";
            return;
        }

        currentStudents = [];
        container.innerHTML = "";
        
        snap.forEach(doc => {
            const s = doc.data();
            currentStudents.push({ id: s.uniqueID, name: s.name });
            
            container.innerHTML += `
                <div class="attendance-card">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <span style="font-weight:bold; color:#888; width:30px;">${s.uniqueID.toString().slice(-3)}</span>
                        <b style="color:var(--primary-color);">${s.name}</b>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="status-label" id="lbl_${s.uniqueID}">Present</span>
                        <label class="switch">
                            <input type="checkbox" checked id="chk_${s.uniqueID}" onchange="updateLabel(${s.uniqueID})">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>`;
        });
        document.getElementById('listInfo').innerText = `${cls} - ${sec} | ${currentStudents.length} Students`;
    } catch (err) { alert(err.message); }
}

function updateLabel(id) {
    const chk = document.getElementById('chk_'+id);
    const lbl = document.getElementById('lbl_'+id);
    lbl.innerText = chk.checked ? "Present" : "Absent";
    lbl.className = chk.checked ? "status-label present-text" : "status-label absent-text";
}

function markAllPresent() {
    currentStudents.forEach(s => {
        document.getElementById('chk_'+s.id).checked = true;
        updateLabel(s.id);
    });
}

async function saveAttendance() {
    const date = document.getElementById('attDate').value;
    const cls = document.getElementById('attClass').value;
    const sec = document.getElementById('attSection').value;
    const batch = db.batch();

    currentStudents.forEach(s => {
        const status = document.getElementById('chk_'+s.id).checked ? "Present" : "Absent";
        // Unique Doc ID format: YYYY-MM-DD_StudentID
        const docRef = db.collection('attendance').doc(`${date}_${s.id}`);
        batch.set(docRef, {
            date: date,
            studentID: s.id,
            studentName: s.name,
            class: cls,
            section: sec,
            status: status,
            timestamp: Date.now()
        });
    });

    try {
        await batch.commit();
        alert("Attendance Record Saved Successfully!");
    } catch (err) { alert("Error: " + err.message); }
}
</script>
</body>
</html>
