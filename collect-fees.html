<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fees | Imperial Treasury</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="init.js"></script>
</head>
<body>

<div class="wrapper">
    <script src="menu.js"></script>

    <div class="main-content">
        <div class="royal-card">
            <h2 class="card-title"><i class="fas fa-cash-register"></i> Fee Treasury Portal</h2>
            
            <div class="form-grid">
                <div class="form-group" style="position:relative;">
                    <label>Find Student (Name/ID)</label>
                    <input type="text" id="stSearch" placeholder="Search..." oninput="searchStudent()">
                    <div id="results" style="position:absolute; width:100%; background:white; z-index:10; box-shadow:0 5px 10px rgba(0,0,0,0.1); border-radius:5px; display:none;"></div>
                </div>
                <div class="form-group">
                    <label>Billing Summary</label>
                    <div id="billInfo" style="padding:12px; background:var(--bg-light); border-radius:8px; font-weight:bold; color:var(--primary);">Select a student...</div>
                </div>
            </div>

            <div id="payArea" style="display:none; margin-top:30px;">
                <div class="form-section" style="background:var(--bg-light); border-left:5px solid var(--accent); padding:20px;">
                    <h4 id="activeName" style="margin:0; color:var(--primary);"></h4>
                    <p id="activeDetails" style="font-size:0.8rem; margin:5px 0; color:#666;"></p>
                </div>

                <div class="form-grid mt-4">
                    <div class="form-group">
                        <label>For Month</label>
                        <select id="pMonth">
                            <option value="April">April</option><option value="May">May</option><script>const months = ["June","July","August","September","October","November","December","January","February","March"]; months.forEach(m => document.write(`<option value="${m}">${m}</option>`));</script>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount (â‚¹)</label>
                        <input type="number" id="pAmount">
                    </div>
                </div>
                <button class="btn-royal w-100 mt-4" onclick="saveFee()"><i class="fas fa-check-circle"></i> Authenticate Payment</button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedStudent = null;

async function searchStudent() {
    const val = document.getElementById('stSearch').value.toLowerCase();
    const resDiv = document.getElementById('results');
    if(val.length < 2) { resDiv.style.display = 'none'; return; }

    const snap = await db.collection('students').get();
    let html = "";
    snap.forEach(doc => {
        const s = doc.data();
        if(s.name.toLowerCase().includes(val) || s.uniqueID.toString().includes(val)) {
            html += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick='selectStudent(${JSON.stringify(s)})'><b>${s.name}</b> (${s.uniqueID})</div>`;
        }
    });
    resDiv.innerHTML = html;
    resDiv.style.display = html ? 'block' : 'none';
}

function selectStudent(s) {
    selectedStudent = s;
    document.getElementById('results').style.display = 'none';
    document.getElementById('stSearch').value = s.name;
    document.getElementById('payArea').style.display = 'block';
    document.getElementById('activeName').innerText = s.name.toUpperCase();
    document.getElementById('activeDetails').innerText = `ID: ${s.uniqueID} | Class: ${s.class} | Father: ${s.father}`;
}

async function saveFee() {
    if(!selectedStudent) return;
    const amt = document.getElementById('pAmount').value;
    const month = document.getElementById('pMonth').value;
    if(!amt) return alert("Enter amount!");

    await db.collection('fee_transactions').add({
        studentID: selectedStudent.uniqueID,
        studentName: selectedStudent.name,
        amount: Number(amt),
        month: month,
        date: new Date().toLocaleDateString('en-GB'),
        timestamp: Date.now()
    });
    alert("Payment Received!");
    location.reload();
}
</script>
</body>
</html>
