<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Collection | The Lalit</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        .search-results {
            position: absolute; width: 95%; background: white; z-index: 100;
            border: 1px solid #ddd; border-top: none; max-height: 200px; overflow-y: auto;
            display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-item:hover { background: var(--bg-light); color: var(--primary-color); }
        .receipt-preview {
            display: none; border: 2px dashed var(--accent-color); padding: 20px;
            background: #fff; margin-top: 20px; border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="main-content">
    <div class="royal-card">
        <h2 class="card-title"><i class="fas fa-cash-register"></i> Fee Treasury & Billing</h2>

        <div class="form-grid mb-4">
            <div class="form-group" style="position: relative;">
                <label>Find Student (Name or ID)</label>
                <div class="input-group" style="display:flex; gap:5px;">
                    <input type="text" id="stSearch" placeholder="Search..." oninput="searchStudent()">
                    <button class="btn-royal" onclick="searchStudent()" style="padding:10px;"><i class="fas fa-search"></i></button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="form-group">
                <label>Expected Monthly Total</label>
                <div id="expectedAmt" style="padding: 12px; background: #e8f4fd; border-radius: 6px; font-weight: bold; color: var(--primary-color);">₹ 0.00</div>
            </div>
        </div>

        <div id="collectionPanel" style="display: none;">
            <div class="form-section">
                <span class="section-title">Payment Details for <span id="activeStudentName" style="color:var(--primary-color)"></span></span>
                <div class="form-grid">
                    <div class="form-group">
                        <label>For Month</label>
                        <select id="pMonth">
                            <option value="April">April</option><option value="May">May</option><option value="June">June</option>
                            <option value="July">July</option><option value="August">August</option><option value="September">September</option>
                            <option value="October">October</option><option value="November">November</option><option value="December">December</option>
                            <option value="January">January</option><option value="February">February</option><option value="March">March</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount Being Paid (₹)</label>
                        <input type="number" id="pAmount" placeholder="Enter Amount" required>
                    </div>
                    <div class="form-group">
                        <label>Payment Mode</label>
                        <select id="pMode">
                            <option value="Cash">Cash</option>
                            <option value="Online / UPI">Online / UPI</option>
                            <option value="Cheque">Cheque</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Remarks</label>
                        <input type="text" id="pRemarks" placeholder="Optional notes">
                    </div>
                </div>
                <button class="btn-royal mt-3 w-100" onclick="processPayment()"><i class="fas fa-check-circle"></i> Complete Transaction & Generate Receipt</button>
            </div>
        </div>

        <div id="receiptArea" class="receipt-preview">
            <div style="text-align: center; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">
                <h3 id="rSchoolName" style="font-family: 'Cinzel'; margin:0;"></h3>
                <p style="font-size: 0.8rem; margin:0;">Official Fee Receipt | Session 2025-26</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; font-size: 0.9rem;">
                <div>
                    <p><b>Receipt No:</b> <span id="rNo"></span></p>
                    <p><b>Student:</b> <span id="rName"></span></p>
                    <p><b>ID:</b> <span id="rID"></span></p>
                </div>
                <div style="text-align: right;">
                    <p><b>Date:</b> <span id="rDate"></span></p>
                    <p><b>Class:</b> <span id="rClass"></span></p>
                    <p><b>Month:</b> <span id="rMonth"></span></p>
                </div>
            </div>
            <div style="background: var(--primary-color); color: var(--accent-color); padding: 15px; text-align: center; margin-top: 15px; font-size: 1.2rem; font-weight: bold; border-radius: 5px;">
                AMOUNT RECEIVED: ₹ <span id="rAmount"></span>
            </div>
            <p style="text-align: center; margin-top: 10px; font-size: 0.8rem; color: #666;">This is a computer-generated receipt. No signature required.</p>
            <button class="btn-royal no-print" onclick="window.print()" style="width: 100%; margin-top: 10px; background: #333;">Print Receipt</button>
        </div>
    </div>
</div>

<script src="menu.js"></script>
<script>
// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyDqDmsMp2eAuHJBcjW-ciO2JcLTXapiIrs",
  authDomain: "the-lalit-d7472.firebaseapp.com",
  projectId: "the-lalit-d7472",
  appId: "1:479237084229:web:31078825739b3c5712ff2c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let activeStudent = null;

async function searchStudent() {
    const val = document.getElementById('stSearch').value.toLowerCase();
    const resDiv = document.getElementById('searchResults');
    if(val.length < 2) { resDiv.style.display = 'none'; return; }

    const snap = await db.collection('students').get();
    let html = "";
    snap.forEach(doc => {
        const s = doc.data();
        if(s.name.toLowerCase().includes(val) || s.uniqueID.toString().includes(val)) {
            html += `<div class="search-item" onclick='selectStudent(${JSON.stringify(s)})'>
                <b>${s.name}</b> (${s.uniqueID}) - Class ${s.class}
            </div>`;
        }
    });
    resDiv.innerHTML = html;
    resDiv.style.display = html ? 'block' : 'none';
}

async function selectStudent(s) {
    activeStudent = s;
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('stSearch').value = s.name;
    document.getElementById('activeStudentName').innerText = s.name + " (" + s.uniqueID + ")";
    document.getElementById('collectionPanel').style.display = 'block';

    // Calculate Expected Fees
    const fDoc = await db.collection('fee_master').doc(s.class).get();
    let total = 0;
    if(fDoc.exists) total += Number(fDoc.data().tuition || 0);
    if(s.hostel === 'Yes' && fDoc.exists) total += Number(fDoc.data().hostel || 0);
    
    if(s.transport === 'Yes' && s.slab) {
        const tDoc = await db.collection('transport_master').doc(s.slab).get();
        if(tDoc.exists) total += Number(tDoc.data().monthly || 0);
    }

    document.getElementById('expectedAmt').innerText = "₹ " + total.toFixed(2);
    document.getElementById('pAmount').value = total;
}

async function processPayment() {
    if(!activeStudent) return;
    const amt = document.getElementById('pAmount').value;
    const month = document.getElementById('pMonth').value;
    const mode = document.getElementById('pMode').value;
    
    if(!amt || amt <= 0) return alert("Enter valid amount!");

    const transID = "REC-" + Date.now().toString().slice(-6);
    const txnData = {
        receiptNo: transID,
        studentID: activeStudent.uniqueID,
        studentName: activeStudent.name,
        class: activeStudent.class,
        amount: Number(amt),
        month: month,
        mode: mode,
        remarks: document.getElementById('pRemarks').value,
        date: new Date().toLocaleDateString('en-GB'),
        timestamp: Date.now()
    };

    await db.collection('fee_transactions').add(txnData);
    
    // Show Receipt
    document.getElementById('rSchoolName').innerText = SCHOOL_CONFIG.name;
    document.getElementById('rNo').innerText = transID;
    document.getElementById('rName').innerText = activeStudent.name;
    document.getElementById('rID').innerText = activeStudent.uniqueID;
    document.getElementById('rDate').innerText = txnData.date;
    document.getElementById('rClass').innerText = activeStudent.class;
    document.getElementById('rMonth').innerText = month;
    document.getElementById('rAmount').innerText = amt;
    
    document.getElementById('receiptArea').style.display = 'block';
    window.scrollTo(0, document.body.scrollHeight);
    alert("Transaction Successful!");
}
</script>
</body>
</html>
